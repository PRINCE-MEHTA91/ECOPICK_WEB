<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPick Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Prevents FOUC (Flash of Unstyled Content)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

<nav class="bg-white shadow-md dark:bg-gray-800">
    <div class="container mx-auto px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="text-2xl font-bold text-green-700 dark:text-green-400">♻️ EcoPick</div>
            <div class="hidden md:block">
                <ul class="flex items-center space-x-4">
                    <li><a href="index.html" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400">Home</a></li>
                    <li><a href="detect.html" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400">Detect</a></li>
                    <li><a href="dashboard.html" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400">Dashboard</a></li>
                    <li><a href="admin.html" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400">Admin</a></li>
                    <li><a href="profile.html" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400">Profile</a></li>
                    <li><button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-green-700 dark:hover:text-green-400 focus:outline-none">
                        </button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Your Dashboard</h1>
    <p class="text-gray-600 dark:text-gray-300 mt-1">Track your recycling history</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <div class="bg-green-500 text-white rounded-lg p-6 shadow-lg transition transform hover:scale-105">
            <h3 class="font-semibold text-lg">Total Sales</h3>
            <div id="totalDetections" class="font-bold text-4xl mt-2">0</div>
        </div>
        <div class="bg-blue-500 text-white rounded-lg p-6 shadow-lg transition transform hover:scale-105">
            <h3 class="font-semibold text-lg">Total Weight (kg)</h3>
            <div id="totalWeight" class="font-bold text-4xl mt-2">0.00</div>
        </div>
        <div class="bg-orange-500 text-white rounded-lg p-6 shadow-lg transition transform hover:scale-105">
            <h3 class="font-semibold text-lg">Total Value</h3>
            <div id="totalValue" class="font-bold text-4xl mt-2">₹0.00</div>
        </div>
    </div>

    <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <select id="materialFilter" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></select>
                <input type="date" id="dateFilter" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                <select id="priceSort" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    <option value="">Sort by Price</option>
                    <option value="high">High to Low</option>
                    <option value="low">Low to High</option>
                </select>
            </div>
            <button onclick="downloadReceipt()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Download Receipt
            </button>
        </div>
    </div>

    <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-x-auto">
        <table id="historyTable" class="min-w-full"></table>
    </div>

    <div id="material-breakdown-summary" class="mt-8">
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {

    let userProfile = null;
    let transactions = [];

    const materialFilter = document.getElementById("materialFilter");
    const dateFilter = document.getElementById("dateFilter");
    const priceSort = document.getElementById("priceSort");

    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/dashboard');
            
            if (!response.ok) {
                window.location.href = 'index.html?auth=required';
                return;
            }
            
            const data = await response.json();

            if (data.status === 'success' && data.user) {
                userProfile = data.user;
                transactions = data.user.transactions || [];
                initializeApp();
            } else {
                window.location.href = 'index.html?auth=failed';
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            document.body.innerHTML = '<h1 class="text-red-500 text-center mt-10">Error</h1><p class="text-center">Could not load dashboard data. Please try again later.</p>';
        }
    }

    function initializeApp() {
        if (!userProfile) return;

        document.querySelector('h1').textContent = `Welcome, ${userProfile.name}!`;
        document.querySelector('p.text-gray-600').textContent = `Here is your recycling history and environmental impact.`;
        document.getElementById("totalDetections").textContent = userProfile.stats.detections || 0;
        document.getElementById("totalWeight").textContent = (userProfile.stats.totalWeight || 0).toFixed(2);
        document.getElementById("totalValue").textContent = "₹" + (userProfile.stats.totalEarnings || 0).toFixed(2);

        const materialSummary = {};
        transactions.forEach(t => {
            if (materialSummary[t.material]) {
                materialSummary[t.material] += t.weight;
            } else {
                materialSummary[t.material] = t.weight;
            }
        });

        const breakdownContainer = document.getElementById("material-breakdown-summary");
        let breakdownHtml = '<h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Material Breakdown (by Weight)</h3>';
        if (Object.keys(materialSummary).length > 0) {
            breakdownHtml += '<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">';
            for (const material in materialSummary) {
                breakdownHtml += `
                    <div class="bg-blue-200 dark:bg-blue-800 text-gray-800 dark:text-white rounded-lg p-4 shadow transition transform hover:scale-105">
                        <h4 class="font-semibold text-lg">${material}</h4>
                        <div class="font-bold text-3xl mt-2">${materialSummary[material].toFixed(2)} kg</div>
                    </div>
                `;
            }
            breakdownHtml += '</div>';
        } else {
            breakdownHtml += '<p class="text-gray-500 dark:text-gray-400">No materials recorded yet.</p>';
        }
        breakdownContainer.innerHTML = breakdownHtml;

        populateMaterialFilter();
        render(transactions);

        materialFilter.addEventListener("change", applyFilters);
        dateFilter.addEventListener("change", applyFilters);
        priceSort.addEventListener("change", applyFilters);
        document.querySelector('button[onclick="downloadReceipt()"]').addEventListener('click', downloadReceipt);
    }

    function populateMaterialFilter() {
        materialFilter.innerHTML = `<option value="">All Materials</option>`;
        const materials = [...new Set(transactions.map(t => t.material))];
        materials.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            materialFilter.appendChild(opt);
        });
    }

    function render(items) {
        const table = document.getElementById("historyTable");
        if (!items || items.length === 0) {
            table.innerHTML = "<tr><td colspan='5' class='text-center py-4 dark:text-gray-300'>You have no recycling history yet.</td></tr>";
            return;
        }

        let html = `
            <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Material</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Weight (kg)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Earnings</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
        `;

        items.forEach(t => {
            html += `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${t.material}</td>
                <td class="px-6 py-4 whitespace-nowrap">${t.weight.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap">₹${t.earnings.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${new Date(t.timestamp).toLocaleDateString()}</td>
            </tr>
            `;
        });
        html += '</tbody>';
        table.innerHTML = html;
    }

    function applyFilters() {
        let filtered = [...transactions];

        if (materialFilter.value) {
            filtered = filtered.filter(t => t.material === materialFilter.value);
        }

        if (dateFilter.value) {
            const selectedDate = new Date(dateFilter.value).toLocaleDateString();
            filtered = filtered.filter(t => new Date(t.timestamp).toLocaleDateString() === selectedDate);
        }

        if (priceSort.value === "high") {
            filtered.sort((a, b) => b.earnings - a.earnings);
        } else if (priceSort.value === "low") {
            filtered.sort((a, b) => a.earnings - b.earnings);
        }

        render(filtered);
    }
    
    window.downloadReceipt = function() {
        if (!userProfile) {
            alert("User data is not loaded.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.width;
        const brandColor = "#0f8b6d";

        doc.setFont("helvetica", "bold");
        doc.setFontSize(26);
        doc.setTextColor(brandColor);
        doc.text("ECOPICK", pageWidth / 2, 20, { align: "center" });
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.setTextColor(brandColor);
        doc.text("Smart Recycling. Real Impact.", pageWidth / 2, 28, { align: "center" });

        const now = new Date();
        const receiptId = `RCPT-${Date.now().toString().slice(-6)}`;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor("#000000");
        doc.text(`Receipt ID: ${receiptId}`, 14, 40);
        doc.text(`Date: ${now.toLocaleDateString()}`, 14, 45);
        doc.text(`Time: ${now.toLocaleTimeString()}`, 14, 50);
        doc.text(`Customer ID: ${userProfile.profileId}`, 14, 55);
        doc.text(`Customer Name: ${userProfile.name}`, 14, 60);
        doc.text(`Phone: ${userProfile.phoneNumber}`, 14, 65);

        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.setTextColor("#666666");
        doc.text("“Your small action today creates a cleaner tomorrow.”", pageWidth / 2, 77, { align: "center" });
        
        doc.setDrawColor("#cccccc");
        doc.line(14, 83, pageWidth - 14, 83);

        const body = [];
        const materialSummary = {};
        
        let filtered = [...transactions];
        if (materialFilter.value) filtered = filtered.filter(t => t.material === materialFilter.value);
        if (dateFilter.value) {
            const selectedDate = new Date(dateFilter.value).toLocaleDateString();
            filtered = filtered.filter(t => new Date(t.timestamp).toLocaleDateString() === selectedDate);
        }

        filtered.forEach(t => {
            if (materialSummary[t.material]) {
                materialSummary[t.material] += t.weight;
            } else {
                materialSummary[t.material] = t.weight;
            }
            body.push([
                t.material,
                t.weight.toFixed(2) + " kg",
                "Rs " + (t.earnings / t.weight).toFixed(2),
                "Rs " + t.earnings.toFixed(2)
            ]);
        });

        doc.autoTable({
            head: [["Material", "Weight", "Price/kg", "Total Price"]],
            body,
            startY: 88,
            theme: 'grid'
        });
        
        let y = doc.lastAutoTable.finalY + 10;
        
        const totalW = userProfile.stats.totalWeight;
        const totalV = userProfile.stats.totalEarnings;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Lifetime Summary", 14, y);
        y += 8;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        let summaryText = "";
        summaryText = `Total items recycled: ${userProfile.stats.detections}`;
        doc.text(summaryText, 14, y);
        y += 5;
        doc.text(`Environmental Impact: Saved approx. ${(totalW * 1.5).toFixed(2)}kg of CO2 emissions.`, 14, y);
        y += 10;

        doc.setDrawColor("#cccccc");
        doc.line(14, y, pageWidth - 14, y);
        y += 8;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text(`Lifetime Weight: ${totalW.toFixed(2)} kg`, 14, y);
        doc.text(`Lifetime Earnings: Rs ${totalV.toFixed(2)}`, pageWidth - 14, y, { align: "right" });
        y += 15;

        const tips = [
            "Try using a reusable water bottle instead of buying single-use plastic ones.",
            "Turn off lights when you leave a room to save energy.",
            "Composting food scraps can reduce landfill waste significantly.",
            "Opt for digital receipts and statements to save paper."
        ];
        const tip = tips[Math.floor(Math.random() * tips.length)];
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.setTextColor("#444444");
        doc.text(`Eco Tip of the Day: ${tip}`, pageWidth / 2, y, { align: "center" });
        y += 15;

        doc.setFont("helvetica", "bold");
        doc.setTextColor(brandColor);
        doc.text("by ECOPICK", pageWidth / 2, y, { align: "center" });

        doc.save(`EcoPick_Receipt_${userProfile.profileId}.pdf`);
    }

    fetchDashboardData();

    setInterval(fetchDashboardData, 5000);

    window.addEventListener('focus', fetchDashboardData);
});
</script>
    <script src="theme.js"></script>
</body>
</html>